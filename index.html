<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Demo</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@900&family=Merriweather:wght@300;700&display=swap" rel="stylesheet">

<style>
:root {
  --dorado: #E9CE99;
  --fondo: #07070a;
}

/* === GENERAL === */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background-color: var(--fondo);
  color: #fff;
  font-family: 'Merriweather', serif;
  overflow: hidden;
}

/* === CONTENEDOR PRINCIPAL*/
.contenedor-principal {
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
}

/* üå≥ √Årbol + Agujero */
#arbol, #agujero {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(1.15);
  height: 100vh;
  width: auto;
  object-fit: contain;
}

#arbol { z-index: 1; }
#agujero {
  z-index: 2;
  pointer-events: none;
}

/* üü• Cuadros negros alrededor del agujero */
.cuadroNegro {
  position: absolute;
  width: calc(clamp(45px, 5.5vw, 80px) * 0.9);
  aspect-ratio: 1 / 1;
  background-color: rgba(0, 0, 0, 0);
  z-index: 3;
  pointer-events: none;
  border-radius: 4px;
}

#cuadro-left-top { top: 50%; left: 48%; transform: translate(-50%, -50%); z-index: 6; }
#cuadro-left-bottom { top: 64%; left: 48%; transform: translate(-50%, -50%); z-index: 6; }
#cuadro-right-top { top: 50%; left: 56%; transform: translate(-50%, -50%); z-index: 6; }
#cuadro-right-bottom { top: 64%; left: 56%; transform: translate(-50%, -50%); z-index: 6; }

#cuadro-central {
  position: absolute;
  width: calc(clamp(45px, 5.5vw, 80px) * 0.9);
  aspect-ratio: 1 / 1;
  background-color: rgba(0, 0, 0, 0);
  z-index: 6;
  border-radius: 4px;
  pointer-events: none;
}

/* === CRISTALES INFERIORES === */
#grilla {
  position: absolute;
  bottom: 12%;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  justify-content: center;
  align-items: center;
  gap: clamp(1.5vw, 3vw, 40px);
  z-index: 7;
}

.cristalCaja {
  width: clamp(45px, 5.5vw, 80px);
  aspect-ratio: 1 / 1;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  overflow: visible;
  margin: 0 -2vw;
}

.cristalCaja img {
  width: 90%;
  height: 90%;
  object-fit: contain;
  mix-blend-mode: screen;
  transition: all 0.5s ease;
}

#cristal-central {
  width: 90%;
  height: 90%;
  object-fit: contain;
  mix-blend-mode: screen;
  animation: palpitar 1.6s infinite ease-in-out;
  position: relative;
  z-index: 6;
}

.palpitando {
  animation: palpitar 1.6s infinite ease-in-out;
  transform-origin: center;
}

@keyframes palpitar {
  0%, 100% { transform: scale(1); opacity: 0.9; }
  50% { transform: scale(1.15); opacity: 1; }
}

/* === TEXTO === */
#tituloCristal {
  position: absolute;
  bottom: 23%;
  left: 50%;
  transform: translateX(-50%);
  font-family: 'Cinzel Decorative', serif;
  font-size: clamp(1.2rem, 2vw, 2rem);
  text-shadow: 0 0 12px var(--dorado);
  opacity: 0;
  transition: opacity 0.6s ease;
}
#tituloCristal.mostrar { opacity: 1; }

#textoFinal {
  position: absolute;
  bottom: 5%;
  left: 50%;
  transform: translateX(-50%);
  font-style: italic;
  text-decoration: underline;
  font-size: clamp(1rem, 1.5vw, 1.2rem);
  opacity: 0;
  cursor: pointer;
  animation: palpitar 2s infinite ease-in-out;
  transition: opacity 1s ease;
}
#textoFinal.mostrar { opacity: 1; }
#textoFinal:hover { color: var(--dorado); }

/* === ANIMACI√ìN DE TRASLADO === */
.cristalVolando {
  position: fixed !important;
  top: 0;
  left: 0;
  transition: transform 1s ease-in-out, opacity 1s ease-in-out;
  z-index: 9999;
  pointer-events: none;
}

/* === RAYOS DE LUZ === */
#rayosLuz {
  position: absolute;
  left: 50%;
  width: 100vw;
  height: 100vh;
  transform: translate(-50%, 0);
  overflow: visible;
  pointer-events: none;
  opacity: 0;
  transition: opacity 1s ease;
  top: 40%;
  z-index: 5;
}

.rayo {
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 8px;
  height: 80vh;
  background: linear-gradient(to top, rgba(255, 230, 180, 0.9), rgba(255, 255, 220, 0));
  transform-origin: bottom center;
  filter: blur(6px);
  opacity: 0.7;
  mix-blend-mode: screen;
  border-radius: 50%;
}


/* üå≥ Fade vertical suave desde arriba hacia abajo */
@keyframes revelarVertical {
  0% {
    -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 0%);
    mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 0%);
    opacity: 0;
    transform: translate(-50%, -52%) scale(1.15); /* comienza apenas m√°s arriba */
  }
  30% {
    opacity: 0.4;
  }
  60% {
    opacity: 0.8;
  }
  100% {
    -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 100%, rgba(0,0,0,0) 100%);
    mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 100%, rgba(0,0,0,0) 100%);
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.15);
  }
}

.revelarRaices {
  animation: revelarVertical 1.5s cubic-bezier(0.45, 0, 0.25, 1) forwards;
  animation-fill-mode: forwards;
  will-change: opacity, transform, mask-image;
}
</style>
</head>

<body>
  <div class="contenedor-principal">
    <img id="arbol" src="img/arbolcompleto00.png" alt="√Årbol m√≠stico">
    <img id="agujero" src="img/agujero.png" alt="Agujero en el √°rbol">

    <div id="cuadro-left-top" class="cuadroNegro"></div>
    <div id="cuadro-left-bottom" class="cuadroNegro"></div>
    <div id="cuadro-right-top" class="cuadroNegro"></div>
    <div id="cuadro-right-bottom" class="cuadroNegro"></div>

    <div id="grilla">
      <div id="cRosa" class="cristalCaja">
        <img src="img/cristales/cristalrosa.png" data-NombreCristal="Rodonita" class="palpitando">
      </div>
      <div id="cVioleta" class="cristalCaja">
        <img src="img/cristales/cristalvioleta.png" data-NombreCristal="Amatista">
      </div>
      <div id="cVerde" class="cristalCaja">
        <img src="img/cristales/cristalverde.png" data-NombreCristal="Jade">
      </div>
      <div id="cAmarillo" class="cristalCaja">
        <img src="img/cristales/cristalamarillo.png" data-NombreCristal="Citrino">
      </div>
    </div>

    <h2 id="tituloCristal"></h2>
    <div id="textoFinal"></div>
  </div>

<script>
const cristales = {
  cRosa: { colorSrc: "img/cristales/cristalrosa.png", bynSrc: "img/cristales/cristalrosabyn.png" },
  cVioleta: { colorSrc: "img/cristales/cristalvioleta.png", bynSrc: "img/cristales/cristalvioletabyn.png" },
  cVerde: { colorSrc: "img/cristales/cristalverde.png", bynSrc: "img/cristales/cristalverdebyn.png" },
  cAmarillo: { colorSrc: "img/cristales/cristalamarillo.png", bynSrc: "img/cristales/cristalamarillobyn.png" }
};

const cuadros = {
  a: "cuadro-left-top",
  b: "cuadro-right-top",
  c: "cuadro-left-bottom",
  d: "cuadro-right-bottom"
};

const ordenCorrecto = { a: "cRosa", b: "cVioleta", c: "cVerde", d: "cAmarillo" };

let cristalActivo = "cRosa";
let interactionLock = false;

/* === Inicializar cristales con orden aleatorio === */
function inicializarCristales() {
  const grilla = document.getElementById("grilla");
  const idsCristales = ["cRosa", "cVioleta", "cVerde", "cAmarillo"];
  const ordenAleatorio = idsCristales.sort(() => Math.random() - 0.5);
  ordenAleatorio.forEach(id => grilla.appendChild(document.getElementById(id)));

  for (let key in cristales) {
    const cristal = document.getElementById(key);
    const img = cristal.querySelector("img");
    img.src = key === cristalActivo ? cristales[key].colorSrc : cristales[key].bynSrc;
    img.classList.remove("palpitando");
    cristal.dataset.fijo = "false";
    cristal.dataset.moving = "false";
    cristal.style.transition = "none";
    cristal.style.transform = "translate(0px, 0px)";
    img.dataset.fijado = "false";
  }

  for (let key in cuadros) {
    const cuadro = document.getElementById(cuadros[key]);
    cuadro.dataset.ocupado = "false";
    cuadro.dataset.cristal = "";
  }

  ["cristal-central", "rayosLuz", "cuadro-central"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.remove();
  });

  interactionLock = false;
}
inicializarCristales();

function mostrarCristal(id) {
  const cristal = document.getElementById(id);
  if (!cristal) return;
  const nombre = cristal.querySelector("img").dataset.NombreCristal;
  const tituloCristal = document.getElementById("tituloCristal");
  tituloCristal.textContent = nombre;
  tituloCristal.classList.add("mostrar");
}

document.addEventListener("keydown", e => {
  if (interactionLock) return;
  const key = e.key.toLowerCase();
  const n = parseInt(key);

 if (!isNaN(n) && n >= 1 && n <= 4) {
  const grilla = document.getElementById("grilla");
  const cristalesEnOrden = Array.from(grilla.children); // Orden actual visual
  const seleccionado = cristalesEnOrden[n - 1]; // El que corresponde al n√∫mero presionado
  if (!seleccionado) return;

  cristalActivo = seleccionado.id;

  cristalesEnOrden.forEach(c => {
    const img = c.querySelector("img");
    if (c.dataset.fijo === "true" || c.dataset.moving === "true" || img.dataset.fijado === "true") return;
    if (c.id === cristalActivo) {
      img.src = cristales[c.id].colorSrc;
      img.classList.add("palpitando");
    } else {
      img.src = cristales[c.id].bynSrc;
      img.classList.remove("palpitando");
    }
  });

  mostrarCristal(cristalActivo);
  return;
}

  if (!cuadros[key]) return;
  const cuadroDestino = document.getElementById(cuadros[key]);
  const cristal = document.getElementById(cristalActivo);
  if (!cristal || cuadroDestino.dataset.ocupado === "true" || cristal.dataset.fijo === "true") return;

  interactionLock = true;
  cristal.dataset.moving = "true";
  const contenedor = document.querySelector(".contenedor-principal");
  const rc = contenedor.getBoundingClientRect();
  const r1 = cristal.getBoundingClientRect();
  const r2 = cuadroDestino.getBoundingClientRect();

  const dx = r2.left - rc.left + r2.width / 2 - (r1.left - rc.left + r1.width / 2);
  const dy = r2.top - rc.top + r2.height / 2 - (r1.top - rc.top + r1.height / 2);

  cristal.style.transition = "transform 1s ease-in-out";
  cristal.style.transform = `translate(${dx}px, ${dy}px)`;

  cristal.addEventListener("transitionend", function onEnd(ev) {
    if (ev.propertyName !== "transform") return;
    cristal.removeEventListener("transitionend", onEnd);
    cristal.style.transition = "none";
    cristal.dataset.fijo = "true";
    cristal.dataset.moving = "false";
    const img = cristal.querySelector("img");
    img.dataset.fijado = "true";
    img.src = cristales[cristalActivo].colorSrc;
    img.classList.remove("palpitando");
    cuadroDestino.dataset.ocupado = "true";
    cuadroDestino.dataset.cristal = cristalActivo;
    interactionLock = false;
    verificarFinal();
  });
});

function verificarFinal() {
  const todosOcupados = Object.values(cuadros).every(id => document.getElementById(id).dataset.ocupado === "true");
  if (!todosOcupados) return;
  let correcto = true;
  for (let k in ordenCorrecto) {
    const cuadro = document.getElementById(cuadros[k]);
    if (cuadro.dataset.cristal !== ordenCorrecto[k]) correcto = false;
  }
  correcto ? mostrarCristalFinal() : setTimeout(() => inicializarCristales(), 500);
}

function mostrarCristalFinal() {
  const cont = document.querySelector(".contenedor-principal");
  let cuadro = document.getElementById("cuadro-central");
  if (!cuadro) {
    cuadro = document.createElement("div");
    cuadro.id = "cuadro-central";
    cont.appendChild(cuadro);
  }

  const lista = ["cuadro-left-top","cuadro-left-bottom","cuadro-right-top","cuadro-right-bottom"];
  let sx=0, sy=0;
  lista.forEach(id=>{
    const r=document.getElementById(id).getBoundingClientRect();
    sx+=r.left+r.width/2; sy+=r.top+r.height/2;
  });
  const rc = cont.getBoundingClientRect();
  const cx=sx/lista.length-rc.left, cy=sy/lista.length-rc.top;
  cuadro.style.left=`${cx}px`; cuadro.style.top=`${cy}px`; cuadro.style.transform="translate(-50%,-50%)";

  let cristal=document.getElementById("cristal-central");
  if(!cristal){
    cristal=document.createElement("img");
    cristal.id="cristal-central";
    cristal.src="img/cristales/cristalceleste.png";
    cuadro.appendChild(cristal);
  }

  let rayos=document.getElementById("rayosLuz");
  if(!rayos){
    rayos=document.createElement("div"); rayos.id="rayosLuz"; cont.appendChild(rayos);
    const rl=document.getElementById("cuadro-left-top").getBoundingClientRect();
    const rr=document.getElementById("cuadro-right-top").getBoundingClientRect();
    const mx=((rl.left+rl.width/2)+(rr.left+rr.width/2))/2-rc.left;
    const my=((rl.top+rl.height/2)+(rr.top+rr.height/2))/2-rc.top;
    rayos.style.left=`${mx}px`; rayos.style.top=`${my-600}px`; rayos.style.transform="translate(-50%,0)";
    [-45,-22.5,0,22.5,45].forEach(a=>{
      const r=document.createElement("div"); r.classList.add("rayo"); r.style.transform=`translateX(-50%) rotate(${a}deg)`; rayos.appendChild(r);
    });
  }
  setTimeout(()=>rayos.style.opacity="1",300);

const arbol = document.getElementById("arbol");
if (arbol) {
  // Crear la capa superior con ra√≠ces
  const capaRaices = document.createElement("img");
  capaRaices.id = "arbolRaices";
  capaRaices.src = "img/arbolcompletoraices.png";
  capaRaices.style.position = "absolute";
  capaRaices.style.top = "50%";
  capaRaices.style.left = "50%";
  capaRaices.style.transform = "translate(-50%, -50%) scale(1.15)";
  capaRaices.style.height = "100vh";
  capaRaices.style.width = "auto";
  capaRaices.style.zIndex = "2"; // ‚Üê encima del √°rbol original
  capaRaices.style.pointerEvents = "none";
  capaRaices.style.opacity = "0";
  capaRaices.classList.add("revelarRaices");

  // Insertar sobre el √°rbol actual (sin eliminarlo)
  arbol.parentNode.insertBefore(capaRaices, arbol.nextSibling);
}
}


// === RESETEAR CON TECLA "P" ===
document.addEventListener("keydown", e => {
  if (e.key.toLowerCase() === "p") {
    // Evita que se dispare mientras se mueve algo
    if (interactionLock) return;

    // Reiniciar cristales y textos
    inicializarCristales();

    // Ocultar texto del cristal y texto final
    const tituloCristal = document.getElementById("tituloCristal");
    const textoFinal = document.getElementById("textoFinal");
    tituloCristal.textContent = "";
    tituloCristal.classList.remove("mostrar");
    textoFinal.textContent = "";
    textoFinal.classList.remove("mostrar");
  }
});

</script>
</body>
</html>
